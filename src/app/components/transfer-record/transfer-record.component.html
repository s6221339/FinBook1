<div class="transfer-history-page">
  <div class="content-container">
    <div class="filter-container" style="display: flex; gap: 2.2rem; flex-wrap: wrap;">
      <!-- 帳戶選擇卡片 -->
      <div class="filter-card">
        <div class="card-header">
          <span class="material-icons">account_balance_wallet</span>
          <span>帳戶選擇</span>
        </div>
        <div class="card-content">
          <div class="custom-form-group">
            <label for="balanceSelect">選擇帳戶</label>
            <select id="balanceSelect" [(ngModel)]="selectedBalanceId" (change)="onBalanceChange()" class="custom-select">
              @for (balance of balanceList; track balance.balanceId) {
                <option [ngValue]="balance.balanceId">{{ balance.name }} (ID: {{ balance.balanceId }})</option>
              }
            </select>
            <div class="custom-hint">目前選擇: {{ getDisplayNameById(selectedBalanceId) || '尚未選擇' }}</div>
          </div>
        </div>
      </div>
      <!-- 日期區間卡片 -->
      <div class="filter-card">
        <div class="card-header">
          <span class="material-icons">date_range</span>
          <span>日期區間</span>
        </div>
        <div class="card-content">
          <div class="custom-form-group">
            <label for="start-date">開始日期</label>
            <input id="start-date" type="date" [(ngModel)]="startDate" (ngModelChange)="applyFilters()" [max]="today" class="custom-select" placeholder="YYYY/MM/DD">
            @if (startDate) {
              <button type="button" (click)="startDate='' ; applyFilters()" class="custom-clear-btn" title="清除開始日期">×</button>
            }
          </div>
          <div class="custom-form-group">
            <label for="end-date">結束日期</label>
            <input id="end-date" type="date" [(ngModel)]="endDate" (ngModelChange)="applyFilters()" [max]="today" class="custom-select" placeholder="YYYY/MM/DD">
            @if (endDate) {
              <button type="button" (click)="endDate='' ; applyFilters()" class="custom-clear-btn" title="清除結束日期">×</button>
            }
          </div>
        </div>
      </div>
    </div>

    <div class="transactions-card">
      <div class="card-header">
        <span class="material-icons">list_alt</span>
        <h3>轉帳紀錄</h3>
        <div class="action-buttons">
          <span class="transaction-count pill-green">共 {{ totalRecords }} 筆</span>
        </div>
      </div>
      <div class="card-content table-content">
        <div class="table-container">
          <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z8 payment-table transactions-table">
            <!-- 交易序號 -->
            <ng-container matColumnDef="rowIndex">
              <th mat-header-cell *matHeaderCellDef class="mat-column-rowIndex">交易序號</th>
              <td mat-cell *matCellDef="let row; let i = index;" class="mat-column-rowIndex">
                {{ (currentPage - 1) * pageSize + i + 1 }}
              </td>
            </ng-container>
            <!-- 日期 -->
            <ng-container matColumnDef="createDate">
              <th mat-header-cell *matHeaderCellDef mat-sort-header class="mat-column-createDate">日期</th>
              <td mat-cell *matCellDef="let row" class="mat-column-createDate">{{ row.createDate }}</td>
            </ng-container>
            <!-- 轉出帳戶 -->
            <ng-container matColumnDef="fromBalanceId">
              <th mat-header-cell *matHeaderCellDef class="mat-column-fromBalanceId">轉出帳戶</th>
              <td mat-cell *matCellDef="let row" class="mat-column-fromBalanceId">
                {{ getDisplayName(row.fromAccount) }}
              </td>
            </ng-container>
            <!-- 轉入帳戶 -->
            <ng-container matColumnDef="toBalanceId">
              <th mat-header-cell *matHeaderCellDef class="mat-column-toBalanceId">轉入帳戶</th>
              <td mat-cell *matCellDef="let row" class="mat-column-toBalanceId">
                {{ getDisplayName(row.toAccount) }}
              </td>
            </ng-container>
            <!-- 金額 -->
            <ng-container matColumnDef="amount">
              <th mat-header-cell *matHeaderCellDef mat-sort-header class="mat-column-amount">金額</th>
              <td mat-cell *matCellDef="let row" [ngClass]="{
                'transfer-out': isOutgoingFromSelectedAccount(row),
                'transfer-in': isIncomingToSelectedAccount(row)
              }" class="mat-column-amount">
                NT$ {{ row.amount | number:'1.0-0' }}
              </td>
            </ng-container>
            <!-- 備註 -->
            <ng-container matColumnDef="description">
              <th mat-header-cell *matHeaderCellDef class="mat-column-description">備註</th>
              <td mat-cell *matCellDef="let row" class="mat-column-description">
                {{ row.description.trim() ? row.description : '（無）' }}
              </td>
            </ng-container>
            <!-- 表頭與表身 -->
            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"
                [ngClass]="{
                  'transfer-out-row': isOutgoingFromSelectedAccount(row),
                  'transfer-in-row': isIncomingToSelectedAccount(row)
                }">
            </tr>
            <!-- 無資料顯示 -->
            <tr class="mat-row no-data-row" *matNoDataRow>
              <td class="mat-cell" colspan="6">
                <div class="empty-state">
                  <mat-icon>search_off</mat-icon>
                  <h3>目前無額度轉移紀錄</h3>
                  <p>請嘗試選擇其他日期區間</p>
                </div>
              </td>
            </tr>
          </table>
        </div>
        <app-custom-paginator
          [totalItems]="totalRecords"
          [currentPage]="currentPage"
          [pageSize]="pageSize"
          (pageChange)="onPageChange($event)"
          (pageSizeChange)="onPageSizeChange($event)">
        </app-custom-paginator>
      </div>
    </div>
  </div>
</div>
